---
kind: "Template"
apiVersion: "v1"
metadata:
  name: "cronjob-registry-prune"
  annotations:
    description: "Scheduled Task to perform a Registry soft prune and redeploy"
    iconClass: "icon-shadowman"
    tags: "management,cronjob,registry,prune"
parameters:
  - name: "NAMESPACE"
    displayName: "Namespace"
    description: "Name of the Namespace where to deploy the Scheduled Job"
    value: "advsol-ops"
    required: true
  - name: "JOB_NAME"
    displayName: "Job Name"
    description: "Name of the Scheduled Job to Create."
    value: "cronjob-registry-soft-prune"
    required: true
  - name: "JOB_SOURCE_SCRIPT"
    displayName: "Job Source Script"
    description: "Name of the Scheduled Job's ConfigMap script to Create."
    value: "soft-prune-script"
    required: true
  - name: "JOB_PERSISTENT_STORAGE_NAME"
    displayName: "Job Persistent Storage Name"
    description: "Name of persistent PVC to use for log retention"
    value: "cronjob-prune-logs"
    required: true
  - name: "PRUNE_KEEP"
    displayName: "Prune Keep Options"
    description: "Keep options to pass to the prune job.  eg: --keep-younger-than=96h"
    required: false
    value: "--keep-younger-than=96h"
  - name: "SCHEDULE"
    displayName: "Cron Schedule"
    description: "Cron Schedule to Execute the Job (in UTC)"
# Currently targeting 5:00 AM
    value: "0 13 * * *"
    required: true
  - name: "JOB_SERVICE_ACCOUNT"
    displayName: "Service Account Name"
    description: "Name of the Service Account To Exeucte the Job As."
    value: "registry-pruner"
    required: true
  - name: "SUCCESS_JOBS_HISTORY_LIMIT"
    displayName: "Successful Job History Limit"
    description: "The number of successful jobs that will be retained"
    value: "5"
    required: true
  - name: "FAILED_JOBS_HISTORY_LIMIT"
    displayName: "Failed Job History Limit"
    description: "The number of failed jobs that will be retained"
    value: "5"
    required: true
  - name: "JOB_BACKOFF_LIMIT"
    displayName: "Job Backoff Limit"
    description: "The number of attempts to try for a successful job outcome (default: 6)"
    value: "1"
    required: false
objects:
- kind: ConfigMap
  apiVersion: v1
  metadata:
    name: ${JOB_SOURCE_SCRIPT}
    namespace: ${NAMESPACE}
    labels:
      template: "cronjob-registry-prune"
  data:
    ${JOB_SOURCE_SCRIPT}: |
      NOOP=
      DATESTAMP=`date +%Y%m%d_%H%M%S`
      LOGDIR='/mnt/oc-prune'
      mkdir -p ${LOGDIR}
      timestamp() { date +"%Y-%m-%d %H:%M:%S %Z"; }
      PRUNE_OPTIONS="${PRUNE_KEEP} --loglevel=4"
      ## Build Prune
      echo "$(timestamp): oc adm prune builds --orphans ${PRUNE_OPTIONS}"
      oc adm prune builds --orphans ${PRUNE_OPTIONS} 2>&1 | tee ${LOGDIR}/${DATESTAMP}-builds-dryrun.log
      rc=${PIPESTATUS[0]}
      gzip ${LOGDIR}/${DATESTAMP}-builds-dryrun.log -f
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Dry-Run Build prune failed, skipping builds prune..."
        exit $rc
      fi
      echo "$(timestamp) oc adm prune builds --orphans ${PRUNE_OPTIONS} --confirm"
      ${NOOP} oc adm prune builds --orphans ${PRUNE_OPTIONS} --confirm 2>&1 | tee ${LOGDIR}/${DATESTAMP}-builds-prune.log
      rc=${PIPESTATUS[0]}
      gzip ${LOGDIR}/${DATESTAMP}-builds-prune.log -f
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Build prune failed."
        exit $rc
      fi
      ## Deployment Prune
      echo "$(timestamp): oc adm prune deployments --orphans ${PRUNE_OPTIONS}"
      oc adm prune deployments --orphans ${PRUNE_OPTIONS} 2>&1 | tee ${LOGDIR}/${DATESTAMP}-deployments-dryrun.log
      rc=${PIPESTATUS[0]}
      gzip ${LOGDIR}/${DATESTAMP}-deployments-dryrun.log -f
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Dry-Run deployments prune failed, skipping deployments prune..."
        exit $rc
      fi
      echo "$(timestamp) oc adm prune deployments --orphans ${PRUNE_OPTIONS} --confirm"
      ${NOOP} oc adm prune deployments --orphans ${PRUNE_OPTIONS} --confirm 2>&1 | tee ${LOGDIR}/${DATESTAMP}-deployments-prune.log
      rc=${PIPESTATUS[0]}
      gzip ${LOGDIR}/${DATESTAMP}-deployments-prune.log -f
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Deployment prune failed."
        exit $rc
      fi
      # Prune
      echo "$(timestamp): oc adm prune images ${PRUNE_OPTIONS}"
      oc adm prune images ${PRUNE_OPTIONS} 2>&1 | tee ${LOGDIR}/${DATESTAMP}-image-dryrun.log
      rc=${PIPESTATUS[0]}
      gzip ${LOGDIR}/${DATESTAMP}-image-dryrun.log -f
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Dry-Run Prune failed, aborting..."
      fi
      echo "$(timestamp) oc adm prune images ${PRUNE_OPTIONS} --confirm"
      ${NOOP} oc adm prune images ${PRUNE_OPTIONS} --confirm 2>&1 | tee ${LOGDIR}/${DATESTAMP}-image-prune.log
      rc=${PIPESTATUS[0]}
      gzip ${LOGDIR}/${DATESTAMP}-image-prune.log -f
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Prune failed, aborting..."
        exit $rc;
      fi
      echo $(timestamp)
      ${NOOP} oc rollout latest dc/docker-registry -n default
      ${NOOP} oc rollout status dc/docker-registry -n default
      echo $(timestamp)
- kind: "CronJob"
  apiVersion: "batch/v1beta1"
  metadata:
    name: "${JOB_NAME}"
    namespace: ${NAMESPACE}
    labels:
      template: "cronjob-registry-prune"
  spec:
    schedule: "${SCHEDULE}"
    concurrencyPolicy: "Forbid"
    successfulJobsHistoryLimit: "${{SUCCESS_JOBS_HISTORY_LIMIT}}"
    failedJobsHistoryLimit: "${{FAILED_JOBS_HISTORY_LIMIT}}"
    jobTemplate:
      spec:
        backoffLimit: ${JOB_BACKOFF_LIMIT}
        template:
          spec:
            containers:
              - name: "${JOB_NAME}"
                image: "openshift3/ose"
                command:
                  - "/bin/bash"
                  - "-c"
                  - "source /etc/config/${JOB_SOURCE_SCRIPT} || :"
                volumeMounts:
                  - mountPath: "/etc/config"
                    name: "registry-prune-volume"
                  - mountPath: "/mnt"
                    name: "registry-prune-log-volume"
            volumes:
              - name: registry-prune-volume
                configMap:
                  items:
                    - key: ${JOB_SOURCE_SCRIPT}
                      path: ${JOB_SOURCE_SCRIPT}
                  name: ${JOB_SOURCE_SCRIPT}
              - name: registry-prune-log-volume
                persistentVolumeClaim:
                  claimName: "${JOB_PERSISTENT_STORAGE_NAME}"
            restartPolicy: "Never"
            terminationGracePeriodSeconds: 30
            activeDeadlineSeconds: 1600
            dnsPolicy: "ClusterFirst"
            serviceAccountName: "${JOB_SERVICE_ACCOUNT}"
            serviceAccount: "${JOB_SERVICE_ACCOUNT}"
- kind: ServiceAccount
  apiVersion: v1
  metadata:
    name: ${JOB_SERVICE_ACCOUNT}
    namespace: ${NAMESPACE}
    labels:
      template: "cronjob-registry-prune"
- kind: ClusterRoleBinding
  apiVersion: v1
  groupNames: null
  metadata:
    name: system:registry-pruners
    namespace: ${NAMESPACE}
    labels:
      template: "cronjob-registry-prune"
  roleRef:
#    name: system:image-pruner
    name: cluster-admin
  subjects:
  - kind: ServiceAccount
    name: ${JOB_SERVICE_ACCOUNT}
  userNames:
  - system:serviceaccount:${NAMESPACE}:${JOB_SERVICE_ACCOUNT}
labels:
  template: "cronjob-registry-prune"
