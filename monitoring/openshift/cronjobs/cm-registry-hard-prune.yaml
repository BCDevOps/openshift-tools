objects:
- kind: ConfigMap
  apiVersion: v1
  metadata:
    name: ${JOB_SOURCE_SCRIPT}
    namespace: ${NAMESPACE}
    labels:
      template: "ops-cronjob"
      cronjob: "${JOB_NAME}"
  data:
    ${JOB_SOURCE_SCRIPT}: |
      #!/usr/bin/env bash
      NOOP=echo
      timestamp() { date +"%Y-%m-%d %H:%M:%S %Z"; }
      PRUNE_OPTIONS="${PRUNE_KEEP} --loglevel=4"
      # perform basic prune (do not trigger rollout as that will occur with readonly mode change)
      # Prune
      echo "$(timestamp): oc adm prune images ${PRUNE_OPTIONS}"
      oc adm prune images ${PRUNE_OPTIONS}
      rc=${PIPESTATUS[0]}
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Dry-Run Prune failed, aborting..."
        exit $rc
      fi
      echo "$(timestamp) oc adm prune images ${PRUNE_OPTIONS} --confirm"
      ${NOOP} oc adm prune images ${PRUNE_OPTIONS} --confirm
      rc=${PIPESTATUS[0]}
      if [ $rc -ne 0 ] ; then
        echo "$(timestamp): Prune failed, aborting..."
        exit $rc;
      fi
      echo $(timestamp)
      # switch registry to read-only mode (will trigger a redeploy)
      ${NOOP} oc env -n default dc/docker-registry 'REGISTRY_STORAGE_MAINTENANCE_READONLY={"enabled":true}'
      # (if required: oc rollout latest dc/docker-registry -n default)
      oc rollout status dc/docker-registry -n default
      echo $(timestamp)
      oc -n default exec "$(oc -n default get pods -l deploymentconfig=docker-registry \
        -o jsonpath=$'{.items[?(.status.phase=="Running")].metadata.name}'| cut -d " " -f1)" \
        -- /usr/bin/dockerregistry -prune=check
      echo $(timestamp)
      ${NOOP} oc -n default exec "$(oc -n default get pods -l deploymentconfig=docker-registry \
        -o jsonpath=$'{.items[?(.status.phase=="Running")].metadata.name}'| cut -d " " -f1)" \
        -- /usr/bin/dockerregistry -prune=delete
      echo $(timestamp)
      # Switch registry back to read-write mode
      ${NOOP} oc env -n default dc/docker-registry REGISTRY_STORAGE_MAINTENANCE_READONLY-
      oc rollout status dc/docker-registry -n default
